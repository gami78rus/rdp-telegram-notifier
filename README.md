Мониторинг RDP-подключений с отправкой уведомлений в Telegram

Данный репозиторий содержит PowerShell-скрипт для отслеживания событий входа и переподключения по протоколу RDP на компьютерах под управлением Windows и отправки детализированных оповещений в чат или группу Telegram.

Основные функции

    Мониторинг событий входа (Event ID 21) и повторного подключения (Event ID 25) по RDP.

    Отправка структурированных уведомлений в заданный чат или группу Telegram.

    Состав уведомления:

        Полное доменное имя (FQDN) хоста.

        Все IPv4-адреса хоста.

        Учетная запись пользователя, выполнившего вход.

        IP-адрес клиента, с которого выполнено подключение.

        DNS-имя клиентского IP-адреса (при возможности разрешения).

        Тип события (Вход/Повторное подключение).

        Идентификатор события (Event ID).

        Временная метка события.

        Полное сообщение из журнала событий.

    Автоматическая установка в качестве запланированной задачи, выполняемой при входе в систему.

    Реализация в виде единого PowerShell-скрипта для упрощения развертывания.

Инструкция по использованию

    Получение токена бота Telegram

        Обратитесь к боту @BotFather в Telegram.

        Используйте команду /newbot для создания нового бота.

        Следуйте инструкциям, укажите имя и имя пользователя (username) для бота.

        Сохраните предоставленный API-токен (например, 123456789:ABC-DEF1234ghy).

    Получение идентификатора чата (Chat ID)

        Для личного чата: Отправьте любое сообщение созданному боту. Затем перешлите это сообщение боту @RawDataBot или @myidbot, чтобы получить идентификатор чата.

        Для группового чата: Добавьте бота в группу, отправьте сообщение в группу. Затем добавьте в группу бота @RawDataBot или @myidbot, который отобразит идентификатор группы (отрицательное число, например, -123456789).

    Настройка скрипта

        Откройте файл install-monitoring.template.ps1 в текстовом редакторе.

        Найдите в коде скрипта следующие переменные:
        powershell

        $BotToken = "ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН"
        $ChatID = "ВАШ_ID_ЧАТА_ИЛИ_ГРУППЫ"

        Замените значение ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН на токен, полученный от BotFather.

        Замените значение ВАШ_ID_ЧАТА_ИЛИ_ГРУППЫ на полученный идентификатор чата.

    Запуск на целевых компьютерах

        Скопируйте измененный файл install-monitoring.template.ps1 на каждый компьютер Windows, где требуется мониторинг RDP-подключений.

        На целевом компьютере выполните скрипт с повышенными привилегиями. Для этого запустите PowerShell или командную строку от имени администратора, перейдите в каталог со скриптом и выполните команду:
        powershell

        powershell.exe -ExecutionPolicy Bypass -File .\install-monitoring.template.ps1

        Скрипт автоматически запросит права администратора при необходимости, установит кодировку вывода UTF-8, создаст необходимые файлы (monitor-rdp.ps1, send-telegram.ps1, log.txt) в каталоге C:\ProgramData\TelegramNotifications и создаст запланированную задачу TelegramRDPAlert для запуска основного скрипта мониторинга при каждом входе в систему.

Принцип работы

Основной скрипт установки (install-monitoring.template.ps1) включает в себя два вспомогательных скрипта:

    monitor-rdp.ps1 — выполняет постоянный мониторинг журнала событий Windows "Безопасность" на предмет событий входа (ID 21) и повторного подключения (ID 25) по RDP. Извлекает релевантную информацию: имя пользователя, исходный IP-адрес, данные хоста.

    send-telegram.ps1 — принимает текст сообщения и отправляет его в заданный чат Telegram через Bot API с использованием командлета Invoke-RestMethod.

Скрипт monitor-rdp.ps1 запускается запланированной задачей при каждом входе в систему, что обеспечивает непрерывный мониторинг. Для диагностики ведется лог-файл C:\ProgramData\TelegramNotifications\log.txt.
